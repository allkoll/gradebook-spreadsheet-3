function updateCalculations() {
  let totalGrades = 0;
  let countGrades = 0;
  let gradeCounts = { '4': 0, '3': 0, '2': 0, '1': 0, 'N': 0 };

  // Calculate grade counts
  for (let assessment of assessments) {
    for (let student of students) {
      const grade = grades[assessment][student];
      if (grade && ['4', '3', '2', '1', 'N'].includes(grade)) {
        gradeCounts[grade]++;
        totalGrades += parseInt(grade) || 0;
        countGrades++;
      }
    }
  }

  // Update proficiency percentage
  const proficientCount = gradeCounts['4'] + gradeCounts['3'];
  const proficiencyPercentage = countGrades > 0 ? (proficientCount / countGrades) * 100 : 0;
  document.getElementById('proficiency-percentage').textContent = `${proficiencyPercentage.toFixed(2)}%`;

  // Update donut chart
  updateChart(gradeCounts);

  // Calculate and update letter grades and skill scores
  updateLetterGrades();
}

function updateChart(gradeCounts) {
  const ctx = document.getElementById('gradeChart').getContext('2d');
  const data = [gradeCounts['4'], gradeCounts['3'], gradeCounts['2'], gradeCounts['1'], gradeCounts['N']];
  const labels = ['4', '3', '2', '1', 'N'];

  if (window.gradeChartInstance) {
    window.gradeChartInstance.data.datasets[0].data = data;
    window.gradeChartInstance.update();
  } else {
    window.gradeChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9E9E9E'],
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      },
    });
  }
}

function updateLetterGrades() {
  students.forEach(student => {
    let totalScore = 0;
    let count = 0;

    assessments.forEach(assessment => {
      const grade = grades[assessment][student];
      if (grade && ['4', '3', '2', '1'].includes(grade)) {
        totalScore += parseInt(grade);
        count++;
      }
    });

    const averageScore = count > 0 ? totalScore / count : 0;
    document.getElementById(`skill-score-${student}`).textContent = averageScore.toFixed(2);

    // Assign letter grade
    let letterGrade = 'F';
    if (averageScore >= 3.5) {
      letterGrade = 'A';
    } else if (averageScore >= 3) {
      letterGrade = 'B';
    } else if (averageScore >= 2) {
      letterGrade = 'C';
    } else if (averageScore >= 1) {
      letterGrade = 'D';
    }

    document.getElementById(`letter-grade-${student}`).textContent = letterGrade;
  });
}
